# Java 异常处理

## 定义与作用

异常处理是Java编程中用于处理程序运行时错误和异常情况的机制。通过异常处理，程序可以在遇到错误时优雅地恢复或终止，而不是直接崩溃。

**主要作用：**
- 提高程序的健壮性和可靠性
- 分离正常业务逻辑和错误处理逻辑
- 提供统一的错误处理机制
- 便于调试和问题定位

## 异常分类体系

### 1. Throwable类层次结构

```java
Throwable
├── Error（错误）
│   ├── OutOfMemoryError
│   ├── StackOverflowError
│   └── VirtualMachineError
└── Exception（异常）
    ├── RuntimeException（运行时异常）
    │   ├── NullPointerException
    │   ├── IndexOutOfBoundsException
    │   ├── IllegalArgumentException
    │   └── ClassCastException
    └── 检查型异常（Checked Exception）
        ├── IOException
        ├── SQLException
        └── FileNotFoundException
```

### 2. Error（错误）

**定义：** 程序无法处理的严重问题，通常与JVM或系统资源相关。

**特点：**
- 应用程序不应该捕获和处理
- 通常表示系统级错误
- 示例：内存溢出、栈溢出、虚拟机错误

### 3. Exception（异常）

#### 3.1 运行时异常（RuntimeException）

**特点：**
- 不需要在编译时强制处理
- 通常由程序逻辑错误引起
- 继承自RuntimeException类

**常见运行时异常：**
- `NullPointerException`：空指针异常
- `IndexOutOfBoundsException`：下标越界异常
- `IllegalArgumentException`：非法参数异常
- `ClassCastException`：类型转换异常

#### 3.2 检查型异常（Checked Exception）

**特点：**
- 必须在编译时处理（捕获或声明抛出）
- 继承自Exception但不继承RuntimeException
- 通常表示外部因素导致的异常

**常见检查型异常：**
- `IOException`：输入输出异常
- `SQLException`：数据库操作异常
- `FileNotFoundException`：文件未找到异常

## 异常处理机制

### 1. try-catch-finally语句

```java
try {
    // 可能抛出异常的代码
    FileInputStream file = new FileInputStream("test.txt");
    int data = file.read();
} catch (FileNotFoundException e) {
    // 处理文件未找到异常
    System.out.println("文件未找到：" + e.getMessage());
} catch (IOException e) {
    // 处理IO异常
    System.out.println("IO错误：" + e.getMessage());
} finally {
    // 无论是否发生异常都会执行
    if (file != null) {
        try {
            file.close();
        } catch (IOException e) {
            System.out.println("关闭文件失败：" + e.getMessage());
        }
    }
}
```

### 2. throw关键字

用于在方法内部主动抛出异常：

```java
public void validateAge(int age) {
    if (age < 0 || age > 150) {
        throw new IllegalArgumentException("年龄必须在0-150之间");
    }
}
```

### 3. throws关键字

用于在方法声明中指定可能抛出的异常类型：

```java
public void readFile(String filename) throws FileNotFoundException, IOException {
    FileInputStream file = new FileInputStream(filename);
    // 文件操作代码
}
```

## 自定义异常

### 1. 创建自定义异常类

```java
// 自定义检查型异常
public class BusinessException extends Exception {
    public BusinessException(String message) {
        super(message);
    }
    
    public BusinessException(String message, Throwable cause) {
        super(message, cause);
    }
}

// 自定义运行时异常
public class ValidationException extends RuntimeException {
    public ValidationException(String message) {
        super(message);
    }
}
```

### 2. 使用自定义异常

```java
public class UserService {
    public void registerUser(String username) throws BusinessException {
        if (username == null || username.trim().isEmpty()) {
            throw new BusinessException("用户名不能为空");
        }
        // 注册逻辑
    }
}
```

## 异常处理最佳实践

### 1. 异常处理原则

**不要忽略异常：**
```java
// 错误做法
catch (Exception e) {
    // 什么都不做
}

// 正确做法
catch (Exception e) {
    logger.error("处理失败", e);
    // 或者重新抛出异常
    throw new BusinessException("处理失败", e);
}
```

**使用具体的异常类型：**
```java
// 错误做法
catch (Exception e) {
    // 过于宽泛
}

// 正确做法
catch (FileNotFoundException e) {
    // 处理特定异常
} catch (IOException e) {
    // 处理IO异常
}
```

### 2. 资源管理

**使用try-with-resources（Java 7+）：**
```java
try (FileInputStream file = new FileInputStream("test.txt");
     BufferedReader reader = new BufferedReader(new InputStreamReader(file))) {
    // 自动资源管理
    String line = reader.readLine();
} catch (IOException e) {
    // 异常处理
}
```

### 3. 异常链

**保留原始异常信息：**
```java
catch (SQLException e) {
    throw new BusinessException("数据库操作失败", e);
}
```

## 常见异常处理模式

### 1. 防御性编程
```java
public void processData(String data) {
    if (data == null) {
        throw new IllegalArgumentException("数据不能为空");
    }
    // 处理逻辑
}
```

### 2. 空对象模式
```java
public String getSafeValue(String value) {
    return value != null ? value : "";
}
```

### 3. 重试机制
```java
public void retryOperation(int maxRetries) {
    for (int i = 0; i < maxRetries; i++) {
        try {
            performOperation();
            break; // 成功则退出循环
        } catch (TemporaryException e) {
            if (i == maxRetries - 1) {
                throw e; // 最后一次失败则抛出异常
            }
            Thread.sleep(1000); // 等待后重试
        }
    }
}
```

## 总结

Java异常处理机制提供了强大的错误处理能力，通过合理的异常分类、处理策略和最佳实践，可以显著提高程序的稳定性和可维护性。关键要点包括：

- 理解异常分类体系（Error、RuntimeException、Checked Exception）
- 掌握try-catch-finally、throw、throws的使用
- 学会创建和使用自定义异常
- 遵循异常处理最佳实践
- 合理使用try-with-resources进行资源管理

通过系统性的异常处理，可以构建更加健壮和可靠的Java应用程序。

最后更新时间：2024-01-15