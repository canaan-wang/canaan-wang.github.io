## 项目介绍
- 背景：蚂蚁线上业务问题发生频繁，经过分析后发现在预发、灰度环境下问题未发现的原因是无流量覆盖。
- 立项目的：为蚂蚁线上所有核心业务在全环境进行流量覆盖，以达到尽早发现业务问题的效果。

## 产品介绍
- 产品模型定义：动作、组件、场景、调度计划
- 流量构建：人工 + 线上流量分析，支持巡检、压测两种场景使用
- 发现机制：告警
- 调度机制：调度计划、事件触发

## 系统架构
- 采用分布式架构
- patrolprod 产品层
- patrolmaster 调度层
- 流量构建层
- patrolexc 网关

## 在线编程、动态发布
- 背景：流量构建层的开发与正常项目开发上线流程相同，对平台来说速度过于缓慢，需要一种快速的方式对流量构建的工作进行提效
- 目的：支持用户在平台 web 页面上进行流量构建代码的开发，并发布到对应的流量构建层服务中执行，且可支持压测。
- 设计方案：
  - web 页面在线化编程：通过嵌入 vscode 以及自研发的用户插件实现，使得用户可以在线化编程并提交
  - Java 代码发布：
    - 阶段1：用户提交后由 vscode 内的自研插件上传用户 Jar 包至 patroprod 产品层，由产品层上传到 Aliyun OSS 并更新 DB
    - 阶段2：流量构建层代码依赖自研的一个脚本 SDK，由 SDK 与产品层交互，分钟级更新加载用户 Java 代码。
  - 用户 Java 代码加载：
    - 已加载 Java 代码缓存池（存储的由 ClassLoader 加载创建的用户 Java 对象）
    - 已加载 Java 代码模型池（存储的平台定义的每一份代码的业务模型）
    - 加载器：
      - 通过 URLClassLoader 对用户编写的 Java 代码进行加载、初始化。
  - Java 代码执行：
    - 执行器：根据运行时上下文信息获取 Java 代码缓存池中对应的 Java 对象并通过反射的方式执行其内部代码。
- 落地：
  - 在线化 Java 代码开发
  - 巡检执行用户 Java 代码
  - 压测执行用户 Java 代码
  - Alipay UDF 执行用户 Java 代码
  - 配置变更防御平台直接使用巡检的在鲜花编程、发布、执行能力
- 开发过程中遇到的问题：
    SDK 升级问题；
        SDK 提供给其它业务程序使用时，SDK 中依赖的 DDS-OSS 与该程序依赖的 Mist 相关包产生了配置方面的冲突，无法通过配置的方式解决。
        SDK 依赖 DDS-OSS 的原因是需要获取 OSS 中对应 Object 有效的 Http Url，因为该 url 有一定的有效时间，所以无法固化。
        将 SDK 获取 OSS Http Url 的逻辑放入巡检平台控制层代码，由 SDK 查询控制层代码获取。
    Log 日志打印问题：
        巡检脚本执行时，日志中的 traceId 未打印。
        发现代码中使用的 Logger 为 Sofa 提供的 Logger Pool 而非官方指定的 TracerLogger。
        对比代码后发现 tracerId 需要显示的放入 mdc 中
        找 Tracer 中间件的同学沟通后，Tracer1.0 版本已不再维护，无法适配我们的场景。
        后续通过在代码中的 LoggerUtil 类中将 TracerId 放入 mdc 中解决。
    FGC：
        线上监控异常，FGC 频繁发生，dump 内存，进行分析后发现是 ClassLoader 过多导致。
        但是代码未发生变动，故有可能是其它配置发生变更。
        后续发现有个同学为了自己测试方便，在 DB 中插入了一条自己新类型的测试脚本，该脚本一直发生加载失败。导致 ClassLoader 过多。
        提交 DB 数据删除工单，执行后，重启所有服务。SDK 层面加了类型配置校验，脚本加载层面将脚本加载失败的 case 也归入已加载的容器中。防止一直加载失败。
- 设计方面的不足
  - 脚本通过 patrolexc 网关访问业务 rpc 接口时依赖业务方提供的模型 Jar
    但是 patrolexc 实例是通过 App ClassLoader 进行加载的
    用户类加载器 super 为 App CassLoader
    故而导致访问 rpc 接口时发生 Class Not Found Exception。
    - 解决方法1：后续通过将 rpc 请求类型 Java 代码的依赖 Jar 由 App ClassLoader 加载解决该问题。但是该方法会影响到用户 Java 代码的隔离性。
    发生隔离性问题需要进行人工干预。
    - 解决方法2：通过 SOFA 提供的服务动态发现进行 rpc 请求访问，该方式的问题是无法通过 patrolexc 网关对业务方发起请求。
  - SDK 设计，设计初期仅考虑到巡检、压测这两种场景下的需求（当前），导致 SDK 的设计更偏向于这两种场景的定制化功能。
    如用户 Java 的基类直接写到 SDK 中
    SDK 的核心能力仅能在 Spring 框架下使用等
    导致用户 Java 代码开发的灵活性不够，SDK 的使用有一定的局限性。
    - 配置变更平台集成该能力：支持用户自定义程序入口。
    - Aliyun UDF：核心能力代码拆分，支持非 Spring 环境下的 Java 代码加载、执行。